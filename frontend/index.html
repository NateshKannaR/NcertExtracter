<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tutor — NCERT / Samacheer Kalvi</title>
    <!-- Google Fonts for a modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --user-msg-bg: linear-gradient(90deg, #6e45ff, #8a6dff);
            --bot-msg-bg: #f0f4f9;
            --primary-text: #333;
            --secondary-text: #555;
            --bg-color: #f9faff;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --button-bg: linear-gradient(90deg, #6e45ff, #8a6dff);
            --button-hover-bg: linear-gradient(90deg, #5a37d1, #7b5ee3);
        }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-color); padding: 20px; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #chat-container { width: 100%; max-width: 700px; background: var(--card-bg); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; height: 85vh; }
        #header { display: flex; justify-content: center; align-items: center; position: relative; margin-bottom: 15px; }
        h1 { color: var(--primary-text); margin: 0; font-weight: 600; }
        #clear-btn { position: absolute; right: 0; background: #f0f4f9; border: none; cursor: pointer; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        #clear-btn:hover { background: #e0e6ed; }
        #clear-btn svg { width: 18px; height: 18px; stroke: #555; }
        #messages { flex-grow: 1; overflow-y: auto; margin-bottom: 15px; padding: 10px; border-top: 1px solid var(--border-color); }
        .msg { margin: 12px 0; padding: 12px 18px; border-radius: 20px; max-width: 85%; line-height: 1.5; word-wrap: break-word; }
        .user { background: var(--user-msg-bg); color: white; margin-left: auto; border-bottom-right-radius: 5px; text-align: right; }
        .bot { background: var(--bot-msg-bg); color: var(--secondary-text); margin-right: auto; border-bottom-left-radius: 5px; text-align: left; }
        .bot.typing { font-style: italic; color: #999; }
        #upload-section { display: flex; gap: 10px; align-items: center; padding: 10px; margin-bottom: 10px; border: 1px dashed var(--border-color); border-radius: 12px; background-color: #fafafa; }
        #upload-btn { padding: 10px 15px; background: var(--button-bg); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; white-space: nowrap; transition: background-color 0.2s; }
        #upload-btn:hover { background: var(--button-hover-bg); }
        #file-name { font-size: 14px; color: var(--secondary-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #file-input { display: none; }
        #input-area { display: flex; gap: 10px; }
        #question { flex-grow: 1; padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); font-size: 16px; }
        #question:focus { outline: none; border-color: #8a6dff; box-shadow: 0 0 0 3px rgba(110, 69, 255, 0.1); }
        #send-btn { padding: 12px 25px; background: var(--button-bg); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; transition: background-color 0.2s; font-weight: 500; }
        #send-btn:hover { background: var(--button-hover-bg); }
        #send-btn:disabled, #upload-btn:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
  <div id="chat-container">
    <div id="header">
      <h1>AI Tutor</h1>
      <button id="clear-btn" title="Clear Chat">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
      </button>
    </div>

    <div id="messages"></div>

    <div id="upload-section">
        <input type="file" id="file-input" accept=".pdf">
        <button id="upload-btn">Upload PDF</button>
        <span id="file-name">No file selected...</span>
    </div>

    <div id="input-area">
      <input type="text" id="question" placeholder="Ask anything..." />
      <button id="send-btn">Send</button>
    </div>
  </div>

  <script>
    // --- ✅ START: FULLY FUNCTIONAL JAVASCRIPT ---

    // --- CONFIGURATION ---
    const API_BASE_URL = "http://127.0.0.1:8000/api/v1";
    const QUERY_ENDPOINT = `${API_BASE_URL}/query`;
    const UPLOAD_ENDPOINT = `${API_BASE_URL}/upload`;

    // --- DOM ELEMENT REFERENCES ---
    const inputEl = document.getElementById("question");
    const messagesEl = document.getElementById("messages");
    const sendButton = document.getElementById("send-btn");
    const uploadButton = document.getElementById("upload-btn");
    const fileInput = document.getElementById("file-input");
    const fileNameEl = document.getElementById("file-name");
    const clearButton = document.getElementById("clear-btn");

    // --- CORE CHAT FUNCTIONS ---

    async function sendQuery() {
        const queryText = inputEl.value.trim();
        if (!queryText) return;
        appendMessage(queryText, "user");
        inputEl.value = "";
        setFormDisabled(true);
        const typingIndicator = appendMessage("AI Tutor is typing...", "bot typing");
        try {
            const response = await fetch(QUERY_ENDPOINT, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ q: queryText })
            });
            messagesEl.removeChild(typingIndicator);
            if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
            const data = await response.json();
            const formattedAnswer = formatApiResponse(data);
            appendMessage(formattedAnswer, "bot");
        } catch (err) {
            if (messagesEl.contains(typingIndicator)) messagesEl.removeChild(typingIndicator);
            appendMessage(`❌ Error: ${err.message}`, "bot");
        } finally {
            setFormDisabled(false);
        }
    }

    function appendMessage(text, className) {
        const msgDiv = document.createElement("div");
        msgDiv.className = `msg ${className}`;
        msgDiv.textContent = text;
        messagesEl.appendChild(msgDiv);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return msgDiv;
    }

    function formatApiResponse(data) {
        if (data.answer && data.answer.evidence && data.answer.evidence.length > 0) {
            return data.answer.evidence.map(item => item.text).join("\n\n---\n\n");
        }
        return "I couldn't find a specific answer. Please upload a relevant PDF to add it to my knowledge base.";
    }

    function setFormDisabled(isDisabled) {
        inputEl.disabled = isDisabled;
        sendButton.disabled = isDisabled;
        uploadButton.disabled = isDisabled;
        inputEl.placeholder = isDisabled ? "Waiting for response..." : "Ask anything...";
    }

    // --- UPLOAD FUNCTIONS ---

    async function uploadFile() {
        const file = fileInput.files[0];
        if (!file) {
            appendMessage("Please select a file first.", "bot");
            return;
        }
        const formData = new FormData();
        formData.append("file", file);
        appendMessage(`Uploading "${file.name}"...`, "bot typing");
        setFormDisabled(true);
        try {
            const response = await fetch(UPLOAD_ENDPOINT, { method: "POST", body: formData });
            if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
            const result = await response.json();
            appendMessage(`✅ Successfully queued "${result.filename}" for processing! You can now ask questions about it.`, "bot");
        } catch (err) {
            appendMessage(`❌ Error uploading file: ${err.message}`, "bot");
        } finally {
            setFormDisabled(false);
            fileInput.value = "";
            fileNameEl.textContent = "No file selected...";
        }
    }

    // --- EVENT LISTENERS ---

    sendButton.addEventListener("click", sendQuery);
    inputEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter") { e.preventDefault(); sendQuery(); }
    });

    uploadButton.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", () => {
        if (fileInput.files.length > 0) {
            fileNameEl.textContent = fileInput.files[0].name;
            uploadFile();
        } else {
            fileNameEl.textContent = "No file selected...";
        }
    });
    
    clearButton.addEventListener("click", () => {
        messagesEl.innerHTML = "";
        appendMessage("Chat cleared. Ask me a new question or upload a document!", "bot");
    });
    
    // Initial greeting
    appendMessage("Hello! I'm your AI Tutor. Upload a PDF to get started.", "bot");

    // --- ✅ END: FULLY FUNCTIONAL JAVASCRIPT ---
  </script>
</body>
</html>

